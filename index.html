<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamGoal Pro - Bireysel Performans Odaklı</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .tab-active { border-bottom: 3px solid #4f46e5; color: #4f46e5; font-weight: 700; }
        .table-row:hover { background-color: #f8fafc; }
        .card-shadow { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05); }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-900">

    <nav class="glass sticky top-0 z-40 border-b border-slate-200 px-6 pt-4">
        <div class="max-w-7xl mx-auto flex flex-col gap-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-indigo-600 p-2 rounded-lg text-white shadow-lg">
                        <i data-lucide="bar-chart-3" class="w-6 h-6"></i>
                    </div>
                    <h1 class="text-xl font-extrabold tracking-tight text-slate-800">TeamGoal Pro <span class="text-[10px] bg-indigo-100 text-indigo-600 px-2 py-0.5 rounded ml-2">DETAYLI</span></h1>
                </div>
                <div class="flex items-center gap-3 bg-emerald-50 border border-emerald-100 px-4 py-2 rounded-2xl shadow-sm">
                    <div class="bg-emerald-500 p-1.5 rounded-lg text-white"><i data-lucide="calendar-days" class="w-4 h-4"></i></div>
                    <div>
                        <p class="text-[10px] text-emerald-600 font-bold uppercase leading-none mb-0.5">Kalan İş Günü</p>
                        <p class="text-lg font-black text-emerald-700 leading-none" id="remainingWorkDaysDisplay">0</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-8 text-sm font-semibold text-slate-500">
                <button onclick="switchTab('performance')" id="tab-performance" class="pb-3 tab-active transition-all">Ekip Performansı</button>
                <button onclick="switchTab('goals')" id="tab-goals" class="pb-3 hover:text-indigo-600 transition-all">Veri & Hedef Yönetimi</button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-6 space-y-12">
        <div id="performanceSection" class="space-y-12 animate-in fade-in duration-500">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-indigo-600 rounded-3xl p-6 text-white shadow-xl shadow-indigo-200">
                    <p class="text-indigo-100 text-sm font-medium mb-1 uppercase tracking-widest text-[10px]">Genel Satış HGO</p>
                    <div class="text-4xl font-black" id="mainHGO">0%</div>
                    <div class="mt-3 w-full bg-indigo-400 rounded-full h-2 overflow-hidden">
                        <div id="mainHGOBar" class="bg-white h-2 rounded-full transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
                <div class="bg-white rounded-3xl p-6 border border-slate-200 card-shadow">
                    <p class="text-slate-400 text-[10px] font-bold mb-1 uppercase tracking-widest">Toplam EG Gerçekleşen</p>
                    <div class="text-3xl font-black text-slate-800" id="mainEG">0 <span class="text-lg text-slate-400 font-medium">/ 0</span></div>
                </div>
                <div class="bg-white rounded-3xl p-6 border border-slate-200 card-shadow border-l-4 border-l-indigo-500">
                    <p class="text-slate-400 text-[10px] font-bold mb-1 uppercase tracking-widest">Toplam Günlük İhtiyaç</p>
                    <div class="text-3xl font-black text-indigo-600" id="mainDailySales">0 ₺</div>
                </div>
            </div>

            <div class="bg-white rounded-3xl border border-slate-200 overflow-hidden card-shadow">
                <div class="p-5 border-b border-slate-100 bg-slate-50/50">
                    <h3 class="font-bold text-slate-800 uppercase text-xs tracking-widest">Hızlı Performans Listesi</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50/50 text-slate-400 text-[9px] uppercase tracking-wider font-bold">
                                <th class="px-6 py-4">Danışman</th>
                                <th class="px-6 py-4 text-center">HGO %</th>
                                <th class="px-6 py-4 text-center">Günlük İhtiyaç</th>
                                <th class="px-6 py-4 text-center">Durum</th>
                            </tr>
                        </thead>
                        <tbody id="performanceTableBody" class="text-xs divide-y divide-slate-100"></tbody>
                        <tfoot id="performanceTableFooter" class="bg-slate-50 font-bold border-t-2 border-slate-200 text-xs"></tfoot>
                    </table>
                </div>
            </div>

            <div>
                <h3 class="text-xl font-extrabold text-slate-800 mb-6 flex items-center gap-2">
                    <i data-lucide="users" class="text-indigo-600"></i> Bireysel Danışman Kartları
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="performanceCards"></div>
            </div>
        </div>

        <div id="goalsSection" class="hidden space-y-8 animate-in slide-in-from-right duration-500">
            <div class="flex items-center justify-between border-b border-slate-200 pb-4">
                <h2 class="text-xl font-extrabold text-slate-800 uppercase tracking-tighter">Veri Giriş Paneli</h2>
                <button onclick="toggleModal('memberModal', true)" class="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-2.5 rounded-2xl flex items-center gap-2 text-sm font-bold shadow-lg shadow-indigo-200 transition-all active:scale-95">
                    <i data-lucide="user-plus" class="w-4 h-4"></i><span>Danışman Ekle</span>
                </button>
            </div>
            <div class="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-slate-50 text-slate-400 text-[9px] uppercase font-bold">
                            <th class="px-6 py-4">İsim</th>
                            <th class="px-6 py-4">Gerçekleşen Satış</th>
                            <th class="px-6 py-4">Satış Hedefi</th>
                            <th class="px-6 py-4">Gerçekleşen EG</th>
                            <th class="px-6 py-4">EG Hedefi</th>
                            <th class="px-6 py-4 text-center">Aksiyon</th>
                        </tr>
                    </thead>
                    <tbody id="managementTableBody" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="memberModal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-8 shadow-2xl animate-in zoom-in duration-200">
            <h3 class="font-black text-2xl text-slate-800 mb-6 tracking-tight">Yeni Danışman Kaydı</h3>
            <form id="memberForm" class="space-y-5">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Tam İsim</label>
                    <input type="text" id="memberName" placeholder="Örn: Ahmet Yılmaz" required class="w-full px-5 py-3 rounded-2xl border border-slate-200 outline-none focus:ring-4 focus:ring-indigo-500/10 focus:border-indigo-500 transition-all">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Satış Hedefi (₺)</label>
                        <input type="number" id="memberSalesTarget" value="1500000" class="w-full px-5 py-3 rounded-2xl border border-slate-200 outline-none focus:ring-4 focus:ring-indigo-500/10">
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">EG Hedefi</label>
                        <input type="number" id="memberEGTarget" value="20" class="w-full px-5 py-3 rounded-2xl border border-slate-200 outline-none focus:ring-4 focus:ring-indigo-500/10">
                    </div>
                </div>
                <div class="pt-4 flex flex-col gap-3">
                    <button type="submit" class="w-full bg-indigo-600 text-white font-black py-4 rounded-2xl hover:bg-indigo-700 shadow-xl shadow-indigo-100 transition-all active:scale-95">SİSTEME KAYDET</button>
                    <button type="button" onclick="toggleModal('memberModal', false)" class="w-full text-slate-400 font-bold text-sm py-2">Vazgeç</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, deleteDoc, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAwyovQyQnhXc8QPbZdl3Y_QY2BGeIaVNo",
            authDomain: "ekiptakip-de668.firebaseapp.com",
            projectId: "ekiptakip-de668",
            storageBucket: "ekiptakip-de668.firebasestorage.app",
            messagingSenderId: "56278883383",
            appId: "1:56278883383:web:0186c346b0e74f7658b3b2",
            measurementId: "G-21YMK7HQKE"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let teamPerformance = [];
        const today = new Date();
        
        // --- İŞ GÜNÜ MANTIKLARI ---
        const calculateTotalWorkDays = () => {
            const last = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            let count = 0;
            for (let i = 1; i <= last; i++) {
                const day = new Date(today.getFullYear(), today.getMonth(), i).getDay();
                if (day !== 0 && day !== 6) count++;
            }
            return count;
        };

        const calculatePassedWorkDays = () => {
            let count = 0;
            for (let i = 1; i <= today.getDate(); i++) {
                const day = new Date(today.getFullYear(), today.getMonth(), i).getDay();
                if (day !== 0 && day !== 6) count++;
            }
            return count || 1;
        };

        const calculateRemainingWorkDays = () => {
            const last = new Date(today.getFullYear(), today.getMonth() + 1, 0).getDate();
            let count = 0;
            for (let i = today.getDate(); i <= last; i++) {
                const day = new Date(today.getFullYear(), today.getMonth(), i).getDay();
                if (day !== 0 && day !== 6) count++;
            }
            return count || 1;
        };

        const totalWorkDays = calculateTotalWorkDays();
        const passedWorkDays = calculatePassedWorkDays();
        const remainingWorkDays = calculateRemainingWorkDays();

        // --- HESAPLAMA ARAÇLARI ---
        const getHGO = (r, t) => t ? parseFloat(((r / t) * 100).toFixed(1)) : 0;
        const getPot = (r, t) => t ? parseFloat((((r / passedWorkDays) * totalWorkDays) / t * 100).toFixed(1)) : 0;
        const getDaily = (r, t) => Math.max(0, Math.ceil((t - r) / remainingWorkDays));

        // --- FIREBASE SYNC ---
        onSnapshot(collection(db, "ekipPerformans"), (snapshot) => {
            teamPerformance = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderUI();
        });

        function renderUI() {
            const tbody = document.getElementById('performanceTableBody');
            const tfoot = document.getElementById('performanceTableFooter');
            const cards = document.getElementById('performanceCards');
            document.getElementById('remainingWorkDaysDisplay').textContent = remainingWorkDays;

            let tR = 0, tT = 0, tE = 0, tET = 0;
            const sorted = teamPerformance.sort((a,b) => getHGO(b.salesRealized, b.salesTarget) - getHGO(a.salesRealized, a.salesTarget));

            // TABLO RENDER
            tbody.innerHTML = sorted.map(p => {
                const hgo = getHGO(p.salesRealized, p.salesTarget);
                tR += p.salesRealized; tT += p.salesTarget; tE += p.egCurrent; tET += p.egTarget;
                return `
                    <tr class="table-row">
                        <td class="px-6 py-4 font-bold text-slate-700">${p.name}</td>
                        <td class="px-6 py-4 text-center font-black ${hgo>=80?'text-emerald-600':'text-amber-500'}">${hgo}%</td>
                        <td class="px-6 py-4 text-center font-bold text-indigo-600">${getDaily(p.salesRealized, p.salesTarget).toLocaleString()} ₺</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 rounded-lg text-[9px] font-black uppercase ${hgo>=80?'bg-emerald-100 text-emerald-700':'bg-amber-50 text-amber-600'}">
                                ${hgo>=80?'SÜPER':'TAKiP'}
                            </span>
                        </td>
                    </tr>`;
            }).join('');

            // TOPLAM SATIRI
            const totalDailySales = teamPerformance.reduce((sum, p) => sum + getDaily(p.salesRealized, p.salesTarget), 0);
            tfoot.innerHTML = `
                <tr class="bg-slate-100 border-t-2 border-slate-200">
                    <td class="px-6 py-4 text-slate-900 font-black uppercase tracking-tighter">EKİP TOPLAMI</td>
                    <td class="px-6 py-4 text-center text-indigo-600 text-base font-black">${getHGO(tR, tT)}%</td>
                    <td class="px-6 py-4 text-center text-indigo-600 font-black">${totalDailySales.toLocaleString()} ₺</td>
                    <td class="px-6 py-4"></td>
                </tr>`;

            // ÜST ÖZET PANELİ GÜNCELLEME
            document.getElementById('mainHGO').textContent = getHGO(tR, tT) + '%';
            document.getElementById('mainHGOBar').style.width = Math.min(getHGO(tR, tT), 100) + '%';
            document.getElementById('mainEG').innerHTML = `${tE} <span class="text-lg text-slate-400 font-medium">/ ${tET}</span>`;
            document.getElementById('mainDailySales').textContent = totalDailySales.toLocaleString() + ' ₺';

            // KİŞİ KARTLARI (İSTEDİĞİN TÜM DETAYLAR BURADA)
            cards.innerHTML = sorted.map(p => {
                const hgo = getHGO(p.salesRealized, p.salesTarget);
                const dS = getDaily(p.salesRealized, p.salesTarget);
                return `
                <div class="bg-white rounded-[2rem] p-7 border border-slate-200 card-shadow hover:scale-[1.02] transition-all duration-300">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="w-14 h-14 rounded-2xl bg-indigo-600 flex items-center justify-center font-black text-white text-xl shadow-lg shadow-indigo-100">
                            ${p.name[0]}
                        </div>
                        <div>
                            <h4 class="font-black text-slate-800 text-lg leading-none">${p.name}</h4>
                            <p class="text-[10px] font-black text-indigo-500 uppercase tracking-[0.2em] mt-2">Satış Danışmanı</p>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="space-y-2">
                            <div class="flex justify-between items-end">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Performans (HGO)</span>
                                <span class="text-xs font-black ${hgo>=80?'text-emerald-600':'text-amber-500'}">%${hgo}</span>
                            </div>
                            <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden shadow-inner">
                                <div class="${hgo>=80?'bg-emerald-500':'bg-amber-500'} h-full transition-all duration-1000" style="width: ${Math.min(hgo, 100)}%"></div>
                            </div>
                            <div class="flex justify-between text-[11px] font-bold">
                                <div class="text-slate-500">G: <span class="text-slate-800">${p.salesRealized.toLocaleString()} ₺</span></div>
                                <div class="text-slate-500">H: <span class="text-slate-800">${p.salesTarget.toLocaleString()} ₺</span></div>
                            </div>
                        </div>

                        <div class="bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">EG Hedef Takip</span>
                                <span class="text-xs font-black text-slate-800">${p.egCurrent} / ${p.egTarget}</span>
                            </div>
                            <div class="w-full bg-slate-200 h-1 rounded-full overflow-hidden">
                                <div class="bg-slate-800 h-full" style="width: ${Math.min((p.egCurrent/p.egTarget)*100, 100)}%"></div>
                            </div>
                        </div>

                        <div class="bg-indigo-600 p-4 rounded-[1.5rem] shadow-lg shadow-indigo-100 text-white flex justify-between items-center">
                            <div class="flex flex-col">
                                <span class="text-[9px] font-black text-indigo-200 uppercase tracking-widest leading-none">Günlük Gereken</span>
                                <span class="text-lg font-black mt-1">${dS.toLocaleString()} ₺</span>
                            </div>
                            <i data-lucide="trending-up" class="w-6 h-6 text-indigo-300 opacity-50"></i>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            lucide.createIcons();
            renderManagement();
        }

        function renderManagement() {
            document.getElementById('managementTableBody').innerHTML = teamPerformance.map(p => `
                <tr class="hover:bg-slate-50 transition-colors">
                    <td class="px-6 py-4 font-bold text-xs text-slate-700">${p.name}</td>
                    <td class="px-2 py-3"><input type="number" onchange="updatePerf('${p.id}', 'salesRealized', this.value)" value="${p.salesRealized}" class="w-full border-slate-200 rounded-xl p-2 text-xs focus:ring-2 focus:ring-indigo-500 outline-none"></td>
                    <td class="px-2 py-3"><input type="number" onchange="updatePerf('${p.id}', 'salesTarget', this.value)" value="${p.salesTarget}" class="w-full border-slate-200 rounded-xl p-2 text-xs focus:ring-2 focus:ring-indigo-500 outline-none"></td>
                    <td class="px-2 py-3"><input type="number" onchange="updatePerf('${p.id}', 'egCurrent', this.value)" value="${p.egCurrent}" class="w-full border-slate-200 rounded-xl p-2 text-xs text-center focus:ring-2 focus:ring-indigo-500 outline-none"></td>
                    <td class="px-2 py-3"><input type="number" onchange="updatePerf('${p.id}', 'egTarget', this.value)" value="${p.egTarget}" class="w-full border-slate-200 rounded-xl p-2 text-xs text-center focus:ring-2 focus:ring-indigo-500 outline-none"></td>
                    <td class="px-6 py-4 text-center"><button onclick="deleteMember('${p.id}')" class="text-slate-300 hover:text-red-500 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                </tr>`).join('');
            lucide.createIcons();
        }

        // --- AKSİYONLAR ---
        window.switchTab = (tab) => {
            document.getElementById('performanceSection').classList.toggle('hidden', tab !== 'performance');
            document.getElementById('goalsSection').classList.toggle('hidden', tab !== 'goals');
            document.getElementById('tab-performance').classList.toggle('tab-active', tab === 'performance');
            document.getElementById('tab-goals').classList.toggle('tab-active', tab === 'goals');
        };

        window.toggleModal = (id, show) => document.getElementById(id).classList.toggle('hidden', !show);

        window.updatePerf = async (id, field, value) => {
            await updateDoc(doc(db, "ekipPerformans", id), { [field]: parseFloat(value) || 0 });
        };

        window.deleteMember = async (id) => {
            if(confirm('Danışmanı silmek istediğine emin misin?')) await deleteDoc(doc(db, "ekipPerformans", id));
        };

        document.getElementById('memberForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await addDoc(collection(db, "ekipPerformans"), {
                name: document.getElementById('memberName').value,
                salesRealized: 0,
                salesTarget: parseFloat(document.getElementById('memberSalesTarget').value) || 1500000,
                egCurrent: 0,
                egTarget: parseFloat(document.getElementById('memberEGTarget').value) || 20
            });
            toggleModal('memberModal', false); e.target.reset();
        });

        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>